{% extends 'base.html' %}
{% from 'components/ui_components.html' import card, icon_card, button, input_group, select_group, textarea_group, table, alert, progress_bar %}

{% block title %}
    {{ super() }}
    AutoTrackr - Supabase
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 text-center u-text-primary u-margin-bottom-lg">
                <i class="fas fa-database mr-3" aria-hidden="true"></i>
                {% set route1 = parameter['route1'] %}
                {{ route1 }}
            </h1>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            {{ icon_card(
                title="Estado de la Conexión",
                icon="fas fa-plug",
                icon_class="text-success",
                body=connection_status_content(),
                card_class="u-shadow-sm u-margin-bottom-md"
            ) }}
        </div>
        
        <div class="col-md-8">
            {{ icon_card(
                title="Gestión de Datos AutoTrackr",
                icon="fas fa-cogs",
                icon_class="text-primary",
                body=data_management_content(),
                card_class="u-shadow u-margin-bottom-md"
            ) }}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            {{ icon_card(
                title="Tablas del Sistema",
                icon="fas fa-table",
                icon_class="text-info",
                body=system_tables_content(),
                card_class="u-shadow-sm u-margin-bottom-md"
            ) }}
        </div>
        
        <div class="col-md-6">
            {{ icon_card(
                title="Operaciones de Mantenimiento",
                icon="fas fa-tools",
                icon_class="text-warning",
                body=maintenance_operations_content(),
                card_class="u-shadow-sm u-margin-bottom-md"
            ) }}
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            {{ icon_card(
                title="Monitor de Actividad",
                icon="fas fa-chart-line",
                icon_class="text-secondary",
                body=activity_monitor_content(),
                card_class="u-shadow-sm"
            ) }}
        </div>
    </div>
</div>

{% macro connection_status_content() %}
<div class="text-center mb-3">
    <div class="mb-3">
        <i class="fas fa-circle text-success fa-3x" aria-hidden="true"></i>
    </div>
    <h5 class="text-success"><strong>Conectado a Supabase</strong></h5>
    <p class="text-muted small">AutoTrackr Database</p>
</div>

<div class="border-top pt-3">
    <div class="row text-center">
        <div class="col-4">
            <h6 class="u-text-primary">15</h6>
            <small class="text-muted">Tablas</small>
        </div>
        <div class="col-4">
            <h6 class="u-text-success">99.2%</h6>
            <small class="text-muted">Uptime</small>
        </div>
        <div class="col-4">
            <h6 class="u-text-info">2.3GB</h6>
            <small class="text-muted">Tamaño</small>
        </div>
    </div>
</div>

<div class="mt-3">
    {{ button(
        text="Probar Conexión",
        variant="outline-success",
        icon="fas fa-heartbeat",
        class="btn-block btn-sm",
        onclick="testConnection()"
    ) }}
</div>

<div class="mt-2">
    {{ button(
        text="Ver Configuración",
        variant="outline-info",
        icon="fas fa-cog",
        class="btn-block btn-sm",
        onclick="showConfig()"
    ) }}
</div>

<div class="mt-3 pt-3 border-top">
    <h6><i class="fas fa-server text-muted mr-2"></i>Información del Servidor</h6>
    <small class="text-muted">
        <strong>Host:</strong> db.autotrackr.supabase.co<br>
        <strong>Puerto:</strong> 5432<br>
        <strong>Base de Datos:</strong> autotrackr_prod
    </small>
</div>
{% endmacro %}

{% macro data_management_content() %}
<div class="row">
    <div class="col-md-6">
        <h6><i class="fas fa-upload text-success mr-2"></i>Importar Datos</h6>
        <form id="importForm">
            {{ select_group(
                name="import_table",
                label="Tabla Destino",
                options=[
                    {"value": "service_orders", "text": "Órdenes de Servicio"},
                    {"value": "customers", "text": "Clientes"},
                    {"value": "technicians", "text": "Técnicos"},
                    {"value": "equipment", "text": "Equipos"},
                    {"value": "parts", "text": "Repuestos"}
                ],
                icon="fas fa-table",
                id="import_table"
            ) }}
            
            <div class="form-group">
                <label class="form-label" for="csvFile">
                    <i class="fas fa-file-csv mr-2" aria-hidden="true"></i>
                    Archivo CSV
                </label>
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="csvFile" accept=".csv" aria-describedby="csvFile-help">
                    <label class="custom-file-label" for="csvFile">Seleccionar archivo...</label>
                </div>
                <small id="csvFile-help" class="form-text text-muted">Selecciona un archivo CSV para importar datos</small>
            </div>
            
            <div class="form-group">
                {{ button(
                    text="Importar Datos",
                    variant="success",
                    icon="fas fa-upload",
                    class="btn-block",
                    onclick="importData()"
                ) }}
            </div>
        </form>
    </div>
    
    <div class="col-md-6">
        <h6><i class="fas fa-download text-primary mr-2"></i>Exportar Datos</h6>
        <form id="exportForm">
            {{ select_group(
                name="export_table",
                label="Tabla Origen",
                options=[
                    {"value": "service_orders", "text": "Órdenes de Servicio"},
                    {"value": "customers", "text": "Clientes"},
                    {"value": "technicians", "text": "Técnicos"},
                    {"value": "equipment", "text": "Equipos"},
                    {"value": "parts", "text": "Repuestos"}
                ],
                icon="fas fa-table",
                id="export_table"
            ) }}
            
            {{ select_group(
                name="export_format",
                label="Formato",
                options=[
                    {"value": "csv", "text": "CSV"},
                    {"value": "json", "text": "JSON"},
                    {"value": "xlsx", "text": "Excel"}
                ],
                selected="csv",
                icon="fas fa-file-export",
                id="export_format"
            ) }}
            
            <div class="form-group">
                {{ button(
                    text="Exportar Datos",
                    variant="primary",
                    icon="fas fa-download",
                    class="btn-block",
                    onclick="exportData()"
                ) }}
            </div>
        </form>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <h6><i class="fas fa-code text-info mr-2"></i>Consulta SQL Personalizada</h6>
        {{ textarea_group(
            name="custom_query",
            placeholder="SELECT * FROM service_orders WHERE status = 'pending';",
            rows="4",
            icon="fas fa-code",
            id="custom_query",
            help_text="Escribe tu consulta SQL personalizada"
        ) }}
        
        <div class="form-group">
            {{ button(
                text="Ejecutar Consulta",
                variant="info",
                icon="fas fa-play",
                onclick="executeCustomQuery()"
            ) }}
            {{ button(
                text="Limpiar",
                variant="outline-secondary",
                icon="fas fa-eraser",
                onclick="clearQuery()"
            ) }}
        </div>
    </div>
</div>
{% endmacro %}

{% macro system_tables_content() %}
<div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
    {{ table(
        headers=["Tabla", "Registros", "Tamaño", "Acciones"],
        caption="Estadísticas de tablas del sistema AutoTrackr",
        rows=[
            [
                '<i class="fas fa-clipboard-list text-primary mr-1"></i>service_orders',
                '<span class="badge badge-info">1,234</span>',
                '2.5 MB',
                '<button class="btn btn-sm btn-outline-primary" onclick="viewTable(\'service_orders\')" title="Ver datos"><i class="fas fa-eye"></i></button>'
            ],
            [
                '<i class="fas fa-users text-success mr-1"></i>customers',
                '<span class="badge badge-info">567</span>',
                '1.2 MB',
                '<button class="btn btn-sm btn-outline-primary" onclick="viewTable(\'customers\')" title="Ver datos"><i class="fas fa-eye"></i></button>'
            ],
            [
                '<i class="fas fa-user-hard-hat text-warning mr-1"></i>technicians',
                '<span class="badge badge-info">45</span>',
                '0.3 MB',
                '<button class="btn btn-sm btn-outline-primary" onclick="viewTable(\'technicians\')" title="Ver datos"><i class="fas fa-eye"></i></button>'
            ],
            [
                '<i class="fas fa-cogs text-info mr-1"></i>equipment',
                '<span class="badge badge-info">890</span>',
                '1.8 MB',
                '<button class="btn btn-sm btn-outline-primary" onclick="viewTable(\'equipment\')" title="Ver datos"><i class="fas fa-eye"></i></button>'
            ],
            [
                '<i class="fas fa-wrench text-secondary mr-1"></i>parts',
                '<span class="badge badge-info">2,345</span>',
                '3.1 MB',
                '<button class="btn btn-sm btn-outline-primary" onclick="viewTable(\'parts\')" title="Ver datos"><i class="fas fa-eye"></i></button>'
            ],
            [
                '<i class="fas fa-file-invoice text-danger mr-1"></i>invoices',
                '<span class="badge badge-info">678</span>',
                '1.5 MB',
                '<button class="btn btn-sm btn-outline-primary" onclick="viewTable(\'invoices\')" title="Ver datos"><i class="fas fa-eye"></i></button>'
            ]
        ],
        striped=true,
        hover=true,
        class="table-sm"
    ) }}
</div>

<div class="mt-3">
    {{ button(
        text="Actualizar Estadísticas",
        variant="outline-info",
        icon="fas fa-sync",
        class="btn-block btn-sm",
        onclick="refreshStats()"
    ) }}
</div>
{% endmacro %}

{% macro maintenance_operations_content() %}
<div class="d-grid gap-2">
    {{ button(
        text="Backup Completo",
        variant="success",
        icon="fas fa-download",
        class="mb-2",
        onclick="fullBackup()"
    ) }}
    
    {{ button(
        text="Backup Incremental",
        variant="outline-success",
        icon="fas fa-save",
        class="mb-2",
        onclick="incrementalBackup()"
    ) }}
    
    {{ button(
        text="Optimizar Tablas",
        variant="warning",
        icon="fas fa-tachometer-alt",
        class="mb-2",
        onclick="optimizeTables()"
    ) }}
    
    {{ button(
        text="Reindexar Base de Datos",
        variant="info",
        icon="fas fa-sort-amount-up",
        class="mb-2",
        onclick="reindexDatabase()"
    ) }}
    
    {{ button(
        text="Limpiar Logs Antiguos",
        variant="secondary",
        icon="fas fa-broom",
        class="mb-2",
        onclick="cleanOldLogs()"
    ) }}
    
    {{ button(
        text="Ver Logs del Sistema",
        variant="outline-dark",
        icon="fas fa-file-alt",
        onclick="viewSystemLogs()"
    ) }}
</div>

<div class="border-top mt-3 pt-3">
    <h6><i class="fas fa-clock text-muted mr-2"></i>Último Mantenimiento</h6>
    <small class="text-muted">
        <strong>Backup:</strong> 2024-01-15 02:00 AM<br>
        <strong>Optimización:</strong> 2024-01-14 03:30 AM<br>
        <strong>Limpieza:</strong> 2024-01-13 01:15 AM
    </small>
</div>
{% endmacro %}

{% macro activity_monitor_content() %}
<div class="row">
    <div class="col-md-8">
        <h6><i class="fas fa-chart-line text-primary mr-2"></i>Actividad de la Base de Datos</h6>
        <div class="text-center p-4 bg-light rounded">
            <i class="fas fa-chart-area fa-3x text-muted mb-3" aria-hidden="true"></i>
            <p class="text-muted"><strong>Gráfico de actividad de la base de datos</strong></p>
            <small class="text-muted">Conexiones activas, consultas por minuto, uso de CPU</small>
        </div>
    </div>
    
    <div class="col-md-4">
        <h6><i class="fas fa-info-circle text-info mr-2"></i>Métricas en Tiempo Real</h6>
        
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <small><strong>Conexiones Activas</strong></small>
                <small><strong>12/100</strong></small>
            </div>
            {{ progress_bar(value=12, max=100, variant="primary", label="12%") }}
        </div>
        
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <small><strong>Uso de CPU</strong></small>
                <small><strong>35%</strong></small>
            </div>
            {{ progress_bar(value=35, variant="success", label="35%") }}
        </div>
        
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <small><strong>Uso de Memoria</strong></small>
                <small><strong>68%</strong></small>
            </div>
            {{ progress_bar(value=68, variant="warning", label="68%") }}
        </div>
        
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <small><strong>Espacio en Disco</strong></small>
                <small><strong>45%</strong></small>
            </div>
            {{ progress_bar(value=45, variant="info", label="45%") }}
        </div>
        
        <div class="text-center mt-3">
            {{ button(
                text="Ver Detalles",
                variant="outline-primary",
                size="sm",
                icon="fas fa-chart-pie",
                onclick="viewDetailedMetrics()"
            ) }}
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <h6><i class="fas fa-history text-secondary mr-2"></i>Consultas Recientes</h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>Hora</th>
                        <th>Usuario</th>
                        <th>Consulta</th>
                        <th>Duración</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>14:35:22</td>
                        <td>admin</td>
                        <td><code>SELECT * FROM service_orders WHERE...</code></td>
                        <td>0.045s</td>
                        <td><span class="badge badge-success">OK</span></td>
                    </tr>
                    <tr>
                        <td>14:34:18</td>
                        <td>tech_user</td>
                        <td><code>UPDATE equipment SET status = 'active'...</code></td>
                        <td>0.023s</td>
                        <td><span class="badge badge-success">OK</span></td>
                    </tr>
                    <tr>
                        <td>14:33:45</td>
                        <td>manager</td>
                        <td><code>INSERT INTO customers (name, email)...</code></td>
                        <td>0.012s</td>
                        <td><span class="badge badge-success">OK</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endmacro %}
{% endblock %}

{% block extra_js %}
<script>
function testConnection() {
    alert('Probando conexión a Supabase AutoTrackr...\n✓ Conexión exitosa\n✓ Autenticación válida\n✓ Base de datos accesible');
}

function showConfig() {
    alert('Mostrando configuración de Supabase...');
}

function importData() {
    const table = document.getElementById('import_table').value;
    const fileInput = document.getElementById('csvFile');
    
    if (!fileInput.files.length) {
        alert('Por favor, selecciona un archivo CSV');
        return;
    }
    
    alert(`Importando datos a la tabla: ${table}`);
}

function exportData() {
    const table = document.getElementById('export_table').value;
    const format = document.getElementById('export_format').value;
    
    alert(`Exportando tabla ${table} en formato ${format.toUpperCase()}`);
}

function executeCustomQuery() {
    const query = document.getElementById('custom_query').value;
    if (!query.trim()) {
        alert('Por favor, ingresa una consulta SQL');
        return;
    }
    
    alert('Ejecutando consulta personalizada...');
}

function clearQuery() {
    document.getElementById('custom_query').value = '';
}

function viewTable(tableName) {
    alert(`Mostrando datos de la tabla: ${tableName}`);
}

function refreshStats() {
    alert('Actualizando estadísticas de las tablas...');
}

function fullBackup() {
    if (confirm('¿Crear backup completo de la base de datos AutoTrackr?')) {
        alert('Iniciando backup completo...');
    }
}

function incrementalBackup() {
    alert('Iniciando backup incremental...');
}

function optimizeTables() {
    if (confirm('¿Optimizar todas las tablas? Esto puede tomar varios minutos.')) {
        alert('Iniciando optimización de tablas...');
    }
}

function reindexDatabase() {
    if (confirm('¿Reindexar la base de datos? Esta operación puede afectar el rendimiento temporalmente.')) {
        alert('Iniciando reindexación...');
    }
}

function cleanOldLogs() {
    if (confirm('¿Limpiar logs antiguos (más de 30 días)?')) {
        alert('Limpiando logs antiguos...');
    }
}

function viewSystemLogs() {
    alert('Abriendo logs del sistema...');
}

function viewDetailedMetrics() {
    alert('Mostrando métricas detalladas del sistema...');
}

// File input label update
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('csvFile');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const fileName = this.files[0] ? this.files[0].name : 'Seleccionar archivo...';
            const label = this.nextElementSibling;
            label.textContent = fileName;
        });
    }
});
</script>
{% endblock %} 