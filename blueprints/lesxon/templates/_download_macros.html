{% from 'components/ui_components.html' import card, icon_card, button, input_group, select_group, checkbox_group, progress_bar, badge, table %}

{% macro download_config_content() %}
<form id="downloadConfigForm">
    {{ select_group(
        name="data_type",
        label="Tipo de Datos",
        options=[
            {"value": "klines", "text": "K-Lines"},
            {"value": "trades", "text": "Transacciones"},
            {"value": "orderbook", "text": "Libro de Órdenes"},
            {"value": "ticker", "text": "Ticker 24h"}
        ],
        selected="klines",
        icon="fas fa-database",
        id="data_type"
    ) }}
    
    {{ input_group(
        name="symbol",
        label="Símbolo",
        type="text",
        placeholder="BTCUSDT",
        value="BTCUSDT",
        icon="fas fa-coins",
        id="symbol"
    ) }}
    
    <div class="row">
        <div class="col-md-6">
            {{ input_group(
                name="start_date",
                label="Fecha Inicio",
                type="date",
                icon="fas fa-calendar-alt",
                id="start_date"
            ) }}
        </div>
        <div class="col-md-6">
            {{ input_group(
                name="end_date",
                label="Fecha Fin",
                type="date",
                icon="fas fa-calendar-alt",
                id="end_date"
            ) }}
        </div>
    </div>
    
    {{ select_group(
        name="format",
        label="Formato de Archivo",
        options=[
            {"value": "csv", "text": "CSV"},
            {"value": "json", "text": "JSON"},
            {"value": "xlsx", "text": "Excel"}
        ],
        selected="csv",
        icon="fas fa-file",
        id="format"
    ) }}
    
    {{ checkbox_group(
        name="compress",
        label="Comprimir archivo (ZIP)",
        checked=true,
        id="compress"
    ) }}
    
    <div class="form-group">
        {{ button(
            text="Iniciar Descarga",
            variant="success",
            icon="fas fa-play",
            class="btn-block",
            onclick="startDownload()"
        ) }}
    </div>
    
    <div class="form-group mb-0">
        {{ button(
            text="Programar Descarga",
            variant="outline-primary",
            icon="fas fa-clock",
            class="btn-block",
            onclick="scheduleDownload()"
        ) }}
    </div>
</form>
{% endmacro %}

{% macro download_status_content() %}
<div class="mb-4">
    <h6 class="d-flex align-items-center justify-content-between">
        <span><i class="fas fa-spinner fa-spin text-primary mr-2"></i>Descargando BTCUSDT K-Lines</span>
        <span class="badge badge-primary">En Progreso</span>
    </h6>
    {{ progress_bar(value=65, variant="primary", striped=true, animated=true, label="65%") }}
    <small class="text-muted">Estimado: 2 minutos restantes</small>
</div>

<div class="mb-4">
    <h6 class="d-flex align-items-center justify-content-between">
        <span><i class="fas fa-check-circle text-success mr-2"></i>ETHUSDT Transacciones</span>
        <span class="badge badge-success">Completado</span>
    </h6>
    {{ progress_bar(value=100, variant="success", label="Completado") }}
    <small class="text-muted">Descargado hace 5 minutos</small>
</div>

<div class="mb-4">
    <h6 class="d-flex align-items-center justify-content-between">
        <span><i class="fas fa-clock text-warning mr-2"></i>ADAUSDT Ticker</span>
        <span class="badge badge-warning">En Cola</span>
    </h6>
    {{ progress_bar(value=0, variant="warning", label="En espera") }}
    <small class="text-muted">Programado para las 15:30</small>
</div>

<div class="text-center">
    {{ button(
        text="Ver Todas las Descargas",
        variant="outline-info",
        icon="fas fa-list",
        onclick="viewAllDownloads()"
    ) }}
</div>
{% endmacro %}

{%- macro download_history_content(history_data) -%}
{%- set ns = namespace(total_size=0.0, total_files=0, successful=0, errors=0) -%}
<div class="table-responsive" role="region" aria-label="Historial de Descargas">
    <table class="table table-striped table-hover" role="table">
        <caption class="sr-only">Historial de descargas de datos financieros</caption>
        <thead>
            <tr role="row">
                <th scope="col" role="columnheader"><i class="fas fa-calendar mr-1"></i>Fecha</th>
                <th scope="col" role="columnheader"><i class="fas fa-database mr-1"></i>Tipo</th>
                <th scope="col" role="columnheader"><i class="fas fa-coins mr-1"></i>Símbolo</th>
                <th scope="col" role="columnheader"><i class="fas fa-file mr-1"></i>Formato</th>
                <th scope="col" role="columnheader"><i class="fas fa-weight mr-1"></i>Tamaño</th>
                <th scope="col" role="columnheader"><i class="fas fa-check-circle mr-1"></i>Estado</th>
                <th scope="col" role="columnheader"><i class="fas fa-cogs mr-1"></i>Acciones</th>
            </tr>
        </thead>
        <tbody>
        {%- if history_data -%}
            {%- set ns.total_files = history_data | length -%}
            {%- for item in history_data -%}
            
            {#- Update summary counters -#}
            {%- set size_value = item.size.split(' ')[0] | float(0) -%}
            {%- set ns.total_size = ns.total_size + size_value -%}
            {%- if item.status == 'Completado' -%}
                {%- set ns.successful = ns.successful + 1 -%}
            {%- elif item.status == 'Error' -%}
                {%- set ns.errors = ns.errors + 1 -%}
            {%- endif -%}

            <tr role="row">
                <td role="cell"><span class="text-muted">{{ item.date }}</span></td>
                <td role="cell"><span class="badge badge-info"><i class="fas fa-chart-line mr-1"></i>{{ item.type }}</span></td>
                <td role="cell"><span class="badge badge-primary">{{ item.symbol }}</span></td>
                <td role="cell"><span class="badge badge-light">{{ item.format }}</span></td>
                <td role="cell"><span class="font-weight-bold">{{ item.size }}</span></td>
                {% set status_badge_map = {
                    'Completado': 'success',
                    'Error': 'danger',
                    'En Progreso': 'primary',
                    'En Cola': 'warning'
                } %}
                {% set status_icon_map = {
                    'Completado': 'fas fa-check',
                    'Error': 'fas fa-exclamation-triangle',
                    'En Progreso': 'fas fa-spinner fa-spin',
                    'En Cola': 'fas fa-clock'
                } %}
                <td role="cell">
                    <span class="badge badge-{{ status_badge_map.get(item.status, 'secondary') }}">
                        <i class="{{ status_icon_map.get(item.status, 'fas fa-question-circle') }} mr-1"></i>
                        {{ item.status }}
                    </span>
                </td>
                <td role="cell">
                    <div class="btn-group btn-group-sm" role="group">
                    {% if item.status == 'Completado' %}
                        <button class="btn btn-outline-primary" onclick="downloadFile('{{ item.filename }}')" title="Descargar archivo"><i class="fas fa-download"></i></button>
                        <button class="btn btn-outline-info" onclick="previewFile('{{ item.filename }}')" title="Vista previa"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-outline-danger" onclick="deleteFile('{{ item.filename }}')" title="Eliminar archivo"><i class="fas fa-trash"></i></button>
                    {% elif item.status == 'Error' %}
                        <button class="btn btn-outline-warning" onclick="retryDownload('{{ item.id }}')" title="Reintentar descarga"><i class="fas fa-redo"></i></button>
                        <button class="btn btn-outline-info" onclick="viewError('{{ item.id }}')" title="Ver error"><i class="fas fa-info-circle"></i></button>
                        <button class="btn btn-outline-danger" onclick="deleteFile('{{ item.filename }}')" title="Eliminar archivo"><i class="fas fa-trash"></i></button>
                    {% endif %}
                    </div>
                </td>
            </tr>
            {%- endfor -%}
        {%- else -%}
            <tr role="row">
                <td colspan="7" class="text-center text-muted" role="cell">No hay historial de descargas disponible.</td>
            </tr>
        {%- endif -%}
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-between align-items-center mt-3">
    <div class="d-flex align-items-center">
        <small class="text-muted mr-3">Total: {{ "%.1f"|format(ns.total_size) }} MB en {{ ns.total_files }} archivos</small>
        {% if ns.successful > 0 %}{{ badge(ns.successful ~ " exitosos", variant="success") }}{% endif %}
        {% if ns.errors > 0 %}{{ badge(ns.errors ~ (" error" if ns.errors == 1 else " errores"), variant="danger") }}{% endif %}
    </div>
    <div>
        {{ button(
            text="Limpiar Completados",
            variant="outline-secondary",
            size="sm",
            icon="fas fa-broom",
            onclick="cleanCompleted()"
        ) }}
    </div>
</div>
{% endmacro %}